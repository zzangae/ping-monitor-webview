<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Monitor Dashboard</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="css/responsive.css">
    <script src="./chart.umd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header" id="mainHeader">
        <h1>ğŸŒ Ping Monitor Dashboard</h1>
        <div class="header-subtitle">Real-time Network Monitoring</div>
        <button class="header-toggle" id="headerToggle" title="í—¤ë” ìµœì†Œí™”/í™•ëŒ€">
            <span id="toggleIcon">â–²</span>
        </button>
    </div>

    <!-- Tab Navigation -->
    <div class="container">
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab-btn" data-tab="notifications">ğŸ”” ì•Œë¦¼ ê¸°ë¡</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <!-- Unified Control Bar -->
            <div class="unified-control-bar">
                <!-- Time Info -->
                <div class="control-group">
                    <div class="time-display">
                        <div class="time-label">í˜„ì¬ ì‹œê°„</div>
                        <div class="time-value large" id="currentTime">00:00:00</div>
                    </div>
                    <div class="time-display">
                        <div class="time-label">í˜„ì¬ ë‚ ì§œ</div>
                        <div class="time-value" id="currentDate">0000-00-00</div>
                    </div>
                    <div class="time-display">
                        <div class="time-label">ëª¨ë‹ˆí„°ë§ ì‹œê°„</div>
                        <div class="time-value" id="uptime">00:00:00</div>
                    </div>
                </div>
                
                <div class="control-divider"></div>
                
                <!-- Tab & Control Buttons -->
                <div class="control-group">
                    <button type="button" class="btn btn-primary" id="toggleBtn">ì¼ì‹œì •ì§€</button>
                    <button type="button" class="btn btn-success" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                
                <div class="control-divider"></div>
                
                <!-- Stats -->
                <div class="control-group" style="flex: 1; justify-content: space-around;">
                    <div class="stat-item-inline">
                        <div class="stat-label">ì „ì²´ IP</div>
                        <div class="stat-value" id="totalIPs">0</div>
                    </div>
                    <div class="stat-item-inline">
                        <div class="stat-label">ì˜¨ë¼ì¸</div>
                        <div class="stat-value" style="color: var(--success);" id="onlineCount">0</div>
                    </div>
                    <div class="stat-item-inline">
                        <div class="stat-label">ì˜¤í”„ë¼ì¸</div>
                        <div class="stat-value" style="color: var(--error);" id="offlineCount">0</div>
                    </div>
                    <div class="stat-item-inline">
                        <div class="stat-label">í‰ê·  ì§€ì—°</div>
                        <div class="stat-value" id="avgLatency">0</div>
                    </div>
                </div>
                
                <div class="control-divider"></div>
                
                <!-- Sort Controls -->
                <div class="control-group">
                    <button class="card-sort-btn" id="sortByName">ì´ë¦„ìˆœ</button>
                    <button class="card-sort-btn" id="sortByLatency">ì§€ì—°ìˆœ</button>
                    <button class="card-sort-btn" id="sortByStatus">ìƒíƒœìˆœ</button>
                </div>
            </div>

            <!-- Comparison Chart -->
            <div class="card" id="comparisonChartCard">
                <div class="card-header">
                    <div class="card-title">IP ë¹„êµ íƒ€ì„ë¼ì¸</div>
                    <button class="chart-settings-btn" id="chartSettingsBtn" title="í‘œì‹œí•  IP ì„ íƒ">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.2-13.2l-4.3 4.3M7.8 16.4l-4.3 4.3M23 12h-6m-6 0H1m17.8-5.2l-4.3 4.3M7.8 7.8L3.5 3.5"></path>
                        </svg>
                    </button>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Chart Settings Modal -->
            <div class="modal" id="chartSettingsModal">
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>í‘œì‹œí•  IP ì„ íƒ</h3>
                        <button class="modal-close" id="closeChartSettings">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="chart-settings-controls">
                            <button class="btn btn-sm btn-secondary" id="selectAllIPs">ì „ì²´ ì„ íƒ</button>
                            <button class="btn btn-sm btn-secondary" id="deselectAllIPs">ì „ì²´ í•´ì œ</button>
                            <button class="btn btn-sm btn-primary" id="saveChartSettings">ì €ì¥</button>
                        </div>
                        <div class="ip-checkbox-list" id="ipCheckboxList">
                            <!-- IP ì²´í¬ë°•ìŠ¤ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Minimized Cards Area -->
            <div id="minimizedCardsArea" class="minimized-cards-area" style="display: none;">
                <div class="minimized-area-header">
                    <span class="minimized-area-title">ğŸ“¦ ìµœì†Œí™”ëœ IP</span>
                    <span class="minimized-count" id="minimizedCount">0</span>
                </div>
                <div id="minimizedCardsContainer" class="minimized-cards-container"></div>
            </div>

            <!-- IP Cards -->
            <div id="ipCardsContainer" class="ip-grid"></div>
        </div>

        <!-- Notifications Tab -->
        <div class="tab-content" id="notifications">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ì „ì²´ ì•Œë¦¼</div>
                    <div class="stat-value" id="notifTotalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">íƒ€ì„ì•„ì›ƒ</div>
                    <div class="stat-value" style="color: var(--error);" id="notifTimeoutCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ë³µêµ¬</div>
                    <div class="stat-value" style="color: var(--success);" id="notifRecoveryCount">0</div>
                </div>
            </div>

            <!-- Notification Log -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì•Œë¦¼ ê¸°ë¡</div>
                </div>
                
                <div class="filter-bar">
                    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
                    <button class="filter-btn" data-filter="timeout">íƒ€ì„ì•„ì›ƒë§Œ</button>
                    <button class="filter-btn" data-filter="recovery">ë³µêµ¬ë§Œ</button>
                </div>

                <div class="notification-list" id="notificationList">
                    <div class="loading">ì•Œë¦¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="modalTitle">IP ìƒì„¸ ì •ë³´</h2>
                    <p id="modalSubtitle" style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;"></p>
                </div>
                <button class="modal-close" id="modalClose">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- Stats -->
                <div class="modal-stats">
                    <div class="modal-stat-card">
                        <div class="modal-stat-label">í˜„ì¬ ì§€ì—°ì‹œê°„</div>
                        <div class="modal-stat-value" id="modalLatency">0 ms</div>
                    </div>
                    <div class="modal-stat-card">
                        <div class="modal-stat-label">ìµœì†Œ</div>
                        <div class="modal-stat-value" style="color: var(--success);" id="modalMin">0 ms</div>
                    </div>
                    <div class="modal-stat-card">
                        <div class="modal-stat-label">í‰ê· </div>
                        <div class="modal-stat-value" style="color: var(--info);" id="modalAvg">0 ms</div>
                    </div>
                    <div class="modal-stat-card">
                        <div class="modal-stat-label">ìµœëŒ€</div>
                        <div class="modal-stat-value" style="color: var(--error);" id="modalMax">0 ms</div>
                    </div>
                    <div class="modal-stat-card">
                        <div class="modal-stat-label">íŒ¨í‚· ì†ì‹¤ë¥ </div>
                        <div class="modal-stat-value" id="modalLoss">0%</div>
                    </div>
                    <div class="modal-stat-card">
                        <div class="modal-stat-label">ìƒíƒœ</div>
                        <div class="modal-stat-value" id="modalStatus">ì˜¤í”„ë¼ì¸</div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="modal-chart-container">
                    <canvas id="modalChart"></canvas>
                </div>

                <!-- Details -->
                <div class="modal-details">
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">ì´ ìš”ì²­</div>
                        <div class="modal-detail-value" id="modalTotal">0</div>
                    </div>
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">ì„±ê³µ</div>
                        <div class="modal-detail-value" style="color: var(--success);" id="modalSuccess">0</div>
                    </div>
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">ì‹¤íŒ¨</div>
                        <div class="modal-detail-value" style="color: var(--error);" id="modalFailed">0</div>
                    </div>
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">ë§ˆì§€ë§‰ ì‘ë‹µ ì‹œê°„</div>
                        <div class="modal-detail-value" id="modalLastResponse">--:--:--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="./chart.umd.min.js"></script>
    <script>
        // Global State
        let isRunning = true;
        let updateInterval;
        let timeInterval;
        let comparisonChart;
        let ipCharts = {};
        let currentData = null;
        let draggedElement = null;
        let draggedIndex = null;
        let startTime = Date.now();
        let pausedElapsed = 0;
        let pausedTime = 0;
        let modalChart = null;
        let currentModalTarget = null;
        
        // Chart Visibility
        let visibleIPs = new Set();
        
        // Notification State
        let allNotifications = [];
        let currentFilter = 'all';

        // Bright Colors for Charts
        const brightColors = [
            '#FF6B9D', '#C44569', '#FFA07A', '#FF8C42',
            '#FFD93D', '#6BCF7F', '#4ECDC4', '#45B7D1',
            '#5F27CD', '#A55EEA', '#FF6348', '#FF9FF3',
            '#54A0FF', '#48DBFB', '#1DD1A1', '#00D2D3',
            '#FD79A8', '#FDCB6E', '#6C5CE7', '#A29BFE',
            '#74B9FF', '#81ECEC', '#55EFC4', '#FFEAA7'
        ];

        // DOMì´ ì¤€ë¹„ëœ í›„ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Initialize charts and data
            initComparisonChart();
            loadData();
            startUpdates();
            
            // Start time updates
            updateTime();
            timeInterval = setInterval(updateTime, 1000);
            
            // Load saved states
            loadHeaderState();
        });

        // ë¸Œë¼ìš°ì € ì¢…ë£Œ ê°ì§€
        let isRefreshing = false;
        
        window.addEventListener('beforeunload', function(e) {
            // ìƒˆë¡œê³ ì¹¨ì¸ì§€ í™•ì¸
            if (performance.navigation.type === 1) {
                isRefreshing = true;
                return;
            }
            
            // ë¸Œë¼ìš°ì € ë‹«ê¸° ì‹œ ì„œë²„ ì¢…ë£Œ ìš”ì²­
            if (!isRefreshing) {
                navigator.sendBeacon('/shutdown');
            }
        });

        function initializeEventListeners() {
            // Header Toggle
            const headerToggle = document.getElementById('headerToggle');
            if (headerToggle) {
                headerToggle.addEventListener('click', () => {
                    const header = document.getElementById('mainHeader');
                    const icon = document.getElementById('toggleIcon');
                    const comparisonCard = document.getElementById('comparisonChartCard');
                    
                    const isCollapsed = header.classList.toggle('collapsed');
                    icon.textContent = isCollapsed ? 'â–¼' : 'â–²';
                    
                    // IP ë¹„êµ íƒ€ì„ë¼ì¸ë„ ìˆ¨ê¹€/í‘œì‹œ
                    if (comparisonCard) {
                        comparisonCard.style.display = isCollapsed ? 'none' : 'block';
                    }
                    
                    // ìƒíƒœ ì €ì¥
                    localStorage.setItem('headerCollapsed', isCollapsed ? '1' : '0');
                });
            }

            // Control Buttons
            const toggleBtn = document.getElementById('toggleBtn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    isRunning = !isRunning;
                    toggleBtn.textContent = isRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘';
                    toggleBtn.className = isRunning ? 'btn btn-primary' : 'btn btn-success';
                    
                    if (isRunning) {
                        startUpdates();
                        if (pausedTime > 0) {
                            const pauseDuration = Date.now() - pausedTime;
                            startTime += pauseDuration;
                            pausedTime = 0;
                        }
                    } else {
                        stopUpdates();
                        pausedTime = Date.now();
                    }
                });
            }

            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const originalText = refreshBtn.textContent;
                    
                    try {
                        refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨ ì¤‘...';
                        refreshBtn.disabled = true;
                        
                        startTime = Date.now();
                        pausedTime = 0;
                        pausedElapsed = 0;
                        updateTime();
                        
                        if (comparisonChart) {
                            comparisonChart.data.labels = [];
                            comparisonChart.data.datasets = [];
                            comparisonChart.update();
                        }
                        
                        Object.keys(ipCharts).forEach(key => {
                            if (ipCharts[key]) {
                                ipCharts[key].destroy();
                            }
                        });
                        ipCharts = {};
                        
                        const ipCardsContainer = document.getElementById('ipCardsContainer');
                        if (ipCardsContainer) {
                            ipCardsContainer.innerHTML = '';
                        }
                        
                        const minimizedCardsContainer = document.getElementById('minimizedCardsContainer');
                        if (minimizedCardsContainer) {
                            minimizedCardsContainer.innerHTML = '';
                        }
                        const minimizedCardsArea = document.getElementById('minimizedCardsArea');
                        if (minimizedCardsArea) {
                            minimizedCardsArea.style.display = 'none';
                        }
                        
                        await loadData();
                        
                        const notificationTab = document.getElementById('notifications');
                        if (notificationTab && notificationTab.classList.contains('active')) {
                            await loadNotifications();
                        }
                    } catch (error) {
                        console.error('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                    } finally {
                        refreshBtn.textContent = originalText;
                        refreshBtn.disabled = false;
                    }
                });
            }

            // Sort Buttons
            const sortByName = document.getElementById('sortByName');
            const sortByLatency = document.getElementById('sortByLatency');
            const sortByStatus = document.getElementById('sortByStatus');
            
            if (sortByName) sortByName.addEventListener('click', () => sortIPCards('name'));
            if (sortByLatency) sortByLatency.addEventListener('click', () => sortIPCards('latency'));
            if (sortByStatus) sortByStatus.addEventListener('click', () => sortIPCards('status'));

            // Modal Buttons
            const modalCloseBtn = document.getElementById('modalClose');
            const detailModal = document.getElementById('detailModal');
            
            if (modalCloseBtn) {
                modalCloseBtn.addEventListener('click', closeDetailModal);
            }
            
            if (detailModal) {
                detailModal.addEventListener('click', (e) => {
                    if (e.target.id === 'detailModal') {
                        closeDetailModal();
                    }
                });
            }

            // Tab Buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const targetId = btn.getAttribute('data-tab');
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    if (targetId === 'notifications') {
                        loadNotifications();
                    }
                });
            });

            // Notification Filter Buttons
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.getAttribute('data-filter');
                    renderNotifications();
                });
            });

            // Chart Settings Modal
            const chartSettingsBtn = document.getElementById('chartSettingsBtn');
            const chartSettingsModal = document.getElementById('chartSettingsModal');
            const closeChartSettings = document.getElementById('closeChartSettings');
            const selectAllIPs = document.getElementById('selectAllIPs');
            const deselectAllIPs = document.getElementById('deselectAllIPs');
            const saveChartSettings = document.getElementById('saveChartSettings');

            if (chartSettingsBtn) {
                chartSettingsBtn.addEventListener('click', () => {
                    openChartSettings();
                });
            }

            if (closeChartSettings) {
                closeChartSettings.addEventListener('click', () => {
                    chartSettingsModal.classList.remove('active');
                });
            }

            if (chartSettingsModal) {
                chartSettingsModal.addEventListener('click', (e) => {
                    if (e.target.id === 'chartSettingsModal') {
                        chartSettingsModal.classList.remove('active');
                    }
                });
            }

            if (selectAllIPs) {
                selectAllIPs.addEventListener('click', () => {
                    selectAllIPsForChart();
                });
            }

            if (deselectAllIPs) {
                deselectAllIPs.addEventListener('click', () => {
                    deselectAllIPsForChart();
                });
            }

            if (saveChartSettings) {
                saveChartSettings.addEventListener('click', () => {
                    saveVisibleIPsState();
                    chartSettingsModal.classList.remove('active');
                });
            }
        }

        // Load saved header state
        function loadHeaderState() {
            const collapsed = localStorage.getItem('headerCollapsed') === '1';
            if (collapsed) {
                const header = document.getElementById('mainHeader');
                const icon = document.getElementById('toggleIcon');
                const comparisonCard = document.getElementById('comparisonChartCard');
                
                if (header) header.classList.add('collapsed');
                if (icon) icon.textContent = 'â–¼';
                if (comparisonCard) comparisonCard.style.display = 'none';
            }
        }

        // Save visible IPs state
        function saveVisibleIPsState() {
            const visibleArray = Array.from(visibleIPs);
            localStorage.setItem('visibleIPs', JSON.stringify(visibleArray));
            console.log('í•„í„° ì„¤ì • ì €ì¥:', visibleArray);
        }

        // Load visible IPs state
        function loadVisibleIPsState() {
            const saved = localStorage.getItem('visibleIPs');
            if (saved) {
                try {
                    const visibleArray = JSON.parse(saved);
                    visibleIPs = new Set(visibleArray);
                    console.log('í•„í„° ì„¤ì • ë¡œë“œ:', visibleArray);
                    return true;
                } catch (e) {
                    console.error('í•„í„° ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
            return false;
        }

        // Save minimized state
        function saveMinimizedState() {
            const minimizedCards = document.querySelectorAll('.ip-card.minimized');
            const minimizedIndices = Array.from(minimizedCards).map(card => card.dataset.index);
            localStorage.setItem('minimizedCards', JSON.stringify(minimizedIndices));
            console.log('ìµœì†Œí™” ìƒíƒœ ì €ì¥:', minimizedIndices);
        }

        // Load minimized state
        function loadMinimizedState() {
            const saved = localStorage.getItem('minimizedCards');
            if (saved) {
                try {
                    const minimizedIndices = JSON.parse(saved);
                    console.log('ìµœì†Œí™” ìƒíƒœ ë¡œë“œ:', minimizedIndices);
                    
                    setTimeout(() => {
                        minimizedIndices.forEach(index => {
                            const card = document.getElementById(`ip-card-${index}`);
                            if (card && !card.classList.contains('minimized')) {
                                toggleMinimize(parseInt(index));
                            }
                        });
                    }, 100);
                } catch (e) {
                    console.error('ìµœì†Œí™” ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
        }

        // Time Update Functions
        function updateTime() {
            const now = new Date();
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
            
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('currentDate').textContent = `${year}-${month}-${day}`;
            
            let elapsed;
            if (!isRunning && pausedTime > 0) {
                elapsed = Math.floor((pausedTime - startTime) / 1000);
            } else {
                elapsed = Math.floor((Date.now() - startTime) / 1000);
            }
            
            const uptimeHours = Math.floor(elapsed / 3600);
            const uptimeMinutes = Math.floor((elapsed % 3600) / 60);
            const uptimeSeconds = elapsed % 60;
            document.getElementById('uptime').textContent = 
                `${String(uptimeHours).padStart(2, '0')}:${String(uptimeMinutes).padStart(2, '0')}:${String(uptimeSeconds).padStart(2, '0')}`;
        }

        // Initialize Charts
        function initComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#e4e6eb' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3f5c' },
                            ticks: { color: '#b0b3b8' }
                        },
                        x: {
                            grid: { color: '#3a3f5c' },
                            ticks: { color: '#b0b3b8' }
                        }
                    }
                }
            });
        }

        function createIPChart(canvasId, index) {
            const ctx = document.getElementById(canvasId);
            const color = brightColors[index % brightColors.length];
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [{
                        label: 'Latency (ms)',
                        data: [],
                        borderColor: color,
                        backgroundColor: color + '30',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3f5c' },
                            ticks: { color: '#b0b3b8' }
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
        }

        // Load Data
        async function loadData() {
            try {
                const response = await fetch('/ping_data.json?t=' + Date.now());
                const data = await response.json();
                currentData = data;
                updateUI(data);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // Update UI
        function updateUI(data) {
            if (!data || !data.targets) return;

            // ì €ì¥ëœ í•„í„° ìƒíƒœ ë¡œë“œ ë˜ëŠ” ì´ˆê¸°í™”
            if (visibleIPs.size === 0) {
                const loaded = loadVisibleIPsState();
                if (!loaded) {
                    data.targets.forEach((_, index) => visibleIPs.add(index));
                }
            }

            // Update global stats
            const onlineCount = data.targets.filter(t => t.online).length;
            const offlineCount = data.targets.length - onlineCount;
            const avgLatency = Math.round(
                data.targets.reduce((sum, t) => sum + (t.online ? t.latency : 0), 0) / 
                (onlineCount || 1)
            );

            document.getElementById('totalIPs').textContent = data.targets.length;
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('offlineCount').textContent = offlineCount;
            document.getElementById('avgLatency').textContent = avgLatency + ' ms';

            // Update comparison chart
            updateComparisonChart(data.targets);

            // Update IP cards
            updateIPCards(data.targets);
            
            // Load minimized state (only first time)
            if (Object.keys(ipCharts).length === data.targets.length) {
                loadMinimizedState();
            }
            
            // Update modal if open
            updateModalIfOpen();
        }

        // Update Comparison Chart
        function updateComparisonChart(targets) {
            const labels = Array(60).fill('').map((_, i) => (60 - i) + 's');
            
            comparisonChart.data.labels = labels;
            
            const filteredTargets = targets.filter((target, index) => visibleIPs.has(index));
            
            comparisonChart.data.datasets = filteredTargets.map((target) => {
                const originalIndex = targets.findIndex(t => t.ip === target.ip && t.name === target.name);
                return {
                    label: target.name,
                    data: target.history,
                    borderColor: brightColors[originalIndex % brightColors.length],
                    backgroundColor: brightColors[originalIndex % brightColors.length] + '20',
                    tension: 0.4,
                    borderWidth: 2,
                    fill: false
                };
            });
            
            comparisonChart.update();
        }

        // Chart Settings Functions
        function openChartSettings() {
            if (!currentData || !currentData.targets) return;
            
            populateIPCheckboxList(currentData.targets);
            document.getElementById('chartSettingsModal').classList.add('active');
        }

        function populateIPCheckboxList(targets) {
            const listContainer = document.getElementById('ipCheckboxList');
            listContainer.innerHTML = '';

            targets.forEach((target, index) => {
                const item = document.createElement('div');
                item.className = 'ip-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `ip-check-${index}`;
                checkbox.checked = visibleIPs.has(index);
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        visibleIPs.add(index);
                    } else {
                        visibleIPs.delete(index);
                    }
                    updateComparisonChart(targets);
                });

                const label = document.createElement('label');
                label.className = 'ip-checkbox-label';
                label.htmlFor = `ip-check-${index}`;
                
                const colorBox = document.createElement('div');
                colorBox.className = 'ip-checkbox-color';
                colorBox.style.backgroundColor = brightColors[index % brightColors.length];
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'ip-checkbox-name';
                nameSpan.textContent = target.name;
                
                const ipSpan = document.createElement('span');
                ipSpan.className = 'ip-checkbox-ip';
                ipSpan.textContent = target.ip;
                
                label.appendChild(colorBox);
                label.appendChild(nameSpan);
                label.appendChild(ipSpan);
                
                item.appendChild(checkbox);
                item.appendChild(label);
                listContainer.appendChild(item);
            });
        }

        function selectAllIPsForChart() {
            if (!currentData || !currentData.targets) return;
            
            currentData.targets.forEach((_, index) => {
                visibleIPs.add(index);
                const checkbox = document.getElementById(`ip-check-${index}`);
                if (checkbox) checkbox.checked = true;
            });
            
            updateComparisonChart(currentData.targets);
        }

        function deselectAllIPsForChart() {
            if (!currentData || !currentData.targets) return;
            
            visibleIPs.clear();
            currentData.targets.forEach((_, index) => {
                const checkbox = document.getElementById(`ip-check-${index}`);
                if (checkbox) checkbox.checked = false;
            });
            
            updateComparisonChart(currentData.targets);
        }

        // Update IP Cards
        function updateIPCards(targets) {
            const container = document.getElementById('ipCardsContainer');
            
            targets.forEach((target, index) => {
                let card = document.getElementById(`ip-card-${index}`);
                
                if (!card) {
                    card = createIPCard(target, index);
                    container.appendChild(card);
                    ipCharts[index] = createIPChart(`chart-${index}`, index);
                }
                
                updateIPCard(card, target, index);
            });
        }

        // Create IP Card
        function createIPCard(target, index) {
            const card = document.createElement('div');
            card.id = `ip-card-${index}`;
            card.className = 'ip-card';
            card.draggable = true;
            card.dataset.index = index;
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);
            
            card.innerHTML = `
                <div class="ip-header">
                    <div>
                        <div class="ip-name">${target.name}</div>
                        <div class="ip-address">${target.ip}</div>
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn card-minimize-btn" onclick="toggleMinimize(${index})" title="ìµœì†Œí™”">âˆ’</button>
                        <button class="card-action-btn card-restore-btn" onclick="toggleMinimize(${index})" title="ë³µì›">+</button>
                        <button class="card-action-btn card-expand-btn" onclick="openDetailModal(${index})" title="ìƒì„¸ë³´ê¸°">âŠ•</button>
                    </div>
                </div>
                <span class="status-badge" id="status-${index}">ì˜¤í”„ë¼ì¸</span>
                <div class="chart-container">
                    <canvas id="chart-${index}"></canvas>
                </div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-item-label">ì§€ì—°ì‹œê°„</div>
                        <div class="stat-item-value" id="latency-${index}">0 ms</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">ìµœì†Œ</div>
                        <div class="stat-item-value" id="min-${index}">0 ms</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">í‰ê· </div>
                        <div class="stat-item-value" id="avg-${index}">0 ms</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">ìµœëŒ€</div>
                        <div class="stat-item-value" id="max-${index}">0 ms</div>
                    </div>
                </div>
                <div class="packet-bars" id="packets-${index}"></div>
            `;
            return card;
        }

        // Drag & Drop Handlers
        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const container = document.getElementById('ipCardsContainer');
                const allCards = [...container.children];
                const draggedPos = allCards.indexOf(draggedElement);
                const targetPos = allCards.indexOf(this);
                
                if (draggedPos < targetPos) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
            }
            
            return false;
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            draggedElement = null;
            draggedIndex = null;
        }

        // Sort Functions
        function sortIPCards(sortBy) {
            if (!currentData || !currentData.targets) return;
            
            const container = document.getElementById('ipCardsContainer');
            const cards = [...container.children];
            
            const targets = currentData.targets.map((target, index) => ({
                target,
                index,
                card: cards[index]
            }));
            
            targets.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.target.name.localeCompare(b.target.name);
                    case 'latency':
                        return b.target.latency - a.target.latency;
                    case 'status':
                        return b.target.online - a.target.online;
                    default:
                        return 0;
                }
            });
            
            container.innerHTML = '';
            targets.forEach(item => {
                container.appendChild(item.card);
            });
        }

        // Toggle Minimize
        function toggleMinimize(index) {
            const card = document.getElementById(`ip-card-${index}`);
            
            if (!card) return;
            
            const isMinimized = card.classList.contains('minimized');
            const ipCardsContainer = document.getElementById('ipCardsContainer');
            const minimizedCardsContainer = document.getElementById('minimizedCardsContainer');
            const minimizedCardsArea = document.getElementById('minimizedCardsArea');
            
            if (isMinimized) {
                card.classList.remove('minimized');
                card.draggable = true;
                ipCardsContainer.appendChild(card);
            } else {
                card.classList.add('minimized');
                card.draggable = false;
                minimizedCardsContainer.appendChild(card);
            }
            
            updateMinimizedArea();
            saveMinimizedState();
        }

        // Update Minimized Area
        function updateMinimizedArea() {
            const minimizedCardsContainer = document.getElementById('minimizedCardsContainer');
            const minimizedCardsArea = document.getElementById('minimizedCardsArea');
            const minimizedCount = document.getElementById('minimizedCount');
            
            const count = minimizedCardsContainer.children.length;
            
            if (count > 0) {
                minimizedCardsArea.style.display = 'block';
            } else {
                minimizedCardsArea.style.display = 'none';
            }
            
            minimizedCount.textContent = count;
        }

        // Open Detail Modal
        function openDetailModal(index) {
            if (!currentData || !currentData.targets[index]) return;
            
            const target = currentData.targets[index];
            currentModalTarget = index;
            
            document.getElementById('modalTitle').textContent = target.name;
            document.getElementById('modalSubtitle').textContent = target.ip;
            
            document.getElementById('modalLatency').textContent = target.latency + ' ms';
            document.getElementById('modalMin').textContent = target.min + ' ms';
            document.getElementById('modalAvg').textContent = Math.round(target.avg) + ' ms';
            document.getElementById('modalMax').textContent = target.max + ' ms';
            
            const lossRate = target.total > 0 ? ((target.failed / target.total) * 100).toFixed(1) : 0;
            document.getElementById('modalLoss').textContent = lossRate + '%';
            document.getElementById('modalStatus').textContent = target.online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
            document.getElementById('modalStatus').style.color = target.online ? 'var(--success)' : 'var(--error)';
            
            document.getElementById('modalTotal').textContent = target.total;
            document.getElementById('modalSuccess').textContent = target.total - target.failed;
            document.getElementById('modalFailed').textContent = target.failed;
            
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            document.getElementById('modalLastResponse').textContent = target.online ? timeStr : 'ì‘ë‹µ ì—†ìŒ';
            
            createModalChart(target, index);
            
            document.getElementById('detailModal').classList.add('active');
        }

        // Close Detail Modal
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
            currentModalTarget = null;
        }

        // Create Modal Chart
        function createModalChart(target, index) {
            if (modalChart) {
                modalChart.destroy();
            }
            
            const ctx = document.getElementById('modalChart');
            const color = brightColors[index % brightColors.length];
            
            const now = new Date();
            const labels = Array(60).fill('').map((_, i) => {
                const time = new Date(now.getTime() - (59 - i) * 1000);
                return `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}:${String(time.getSeconds()).padStart(2, '0')}`;
            });
            
            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì§€ì—°ì‹œê°„ (ms)',
                        data: target.history,
                        borderColor: color,
                        backgroundColor: color + '30',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 1,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { 
                                color: '#e4e6eb', 
                                font: { size: 12 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 11 },
                            padding: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3f5c' },
                            ticks: { 
                                color: '#b0b3b8',
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: { color: '#3a3f5c' },
                            ticks: { 
                                color: '#b0b3b8',
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12
                            }
                        }
                    }
                }
            });
        }

        // Update Modal if Open
        function updateModalIfOpen() {
            if (currentModalTarget !== null && currentData && currentData.targets[currentModalTarget]) {
                const target = currentData.targets[currentModalTarget];
                
                document.getElementById('modalLatency').textContent = target.latency + ' ms';
                document.getElementById('modalMin').textContent = target.min + ' ms';
                document.getElementById('modalAvg').textContent = Math.round(target.avg) + ' ms';
                document.getElementById('modalMax').textContent = target.max + ' ms';
                
                const lossRate = target.total > 0 ? ((target.failed / target.total) * 100).toFixed(1) : 0;
                document.getElementById('modalLoss').textContent = lossRate + '%';
                document.getElementById('modalStatus').textContent = target.online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
                document.getElementById('modalStatus').style.color = target.online ? 'var(--success)' : 'var(--error)';
                
                document.getElementById('modalTotal').textContent = target.total;
                document.getElementById('modalSuccess').textContent = target.total - target.failed;
                document.getElementById('modalFailed').textContent = target.failed;
                
                if (modalChart) {
                    const now = new Date();
                    const labels = Array(60).fill('').map((_, i) => {
                        const time = new Date(now.getTime() - (59 - i) * 1000);
                        return `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}:${String(time.getSeconds()).padStart(2, '0')}`;
                    });
                    
                    modalChart.data.labels = labels;
                    modalChart.data.datasets[0].data = target.history;
                    modalChart.update();
                }
                
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                document.getElementById('modalLastResponse').textContent = target.online ? timeStr : 'ì‘ë‹µ ì—†ìŒ';
            }
        }

        // Update IP Card
        function updateIPCard(card, target, index) {
            const statusBadge = card.querySelector(`#status-${index}`);
            if (statusBadge) {
                statusBadge.textContent = target.online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
                statusBadge.className = target.online ? 'status-badge status-online' : 'status-badge status-offline';
            }

            const latencyEl = document.getElementById(`latency-${index}`);
            if (latencyEl) latencyEl.textContent = target.latency + ' ms';
            
            const minEl = document.getElementById(`min-${index}`);
            if (minEl) minEl.textContent = target.min + ' ms';
            
            const avgEl = document.getElementById(`avg-${index}`);
            if (avgEl) avgEl.textContent = Math.round(target.avg) + ' ms';
            
            const maxEl = document.getElementById(`max-${index}`);
            if (maxEl) maxEl.textContent = target.max + ' ms';

            if (ipCharts[index] && !card.classList.contains('minimized')) {
                ipCharts[index].data.datasets[0].data = target.history;
                ipCharts[index].update();
            }

            const packetsContainer = document.getElementById(`packets-${index}`);
            if (packetsContainer) {
                packetsContainer.innerHTML = target.history.map(latency => {
                    const className = latency > 0 ? 'packet-bar packet-success' : 'packet-bar packet-fail';
                    return `<div class="${className}"></div>`;
                }).join('');
            }
        }

        // Load Notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/notification_log.json?t=' + Date.now());
                if (!response.ok) {
                    showEmptyNotifications();
                    return;
                }
                
                const logs = await response.json();
                allNotifications = logs.reverse();
                
                updateNotificationStats();
                renderNotifications();
            } catch (error) {
                console.error('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                showEmptyNotifications();
            }
        }

        // Update Notification Stats
        function updateNotificationStats() {
            const total = allNotifications.length;
            const timeouts = allNotifications.filter(n => n.type === 'timeout').length;
            const recoveries = allNotifications.filter(n => n.type === 'recovery').length;

            document.getElementById('notifTotalCount').textContent = total;
            document.getElementById('notifTimeoutCount').textContent = timeouts;
            document.getElementById('notifRecoveryCount').textContent = recoveries;
        }

        // Render Notifications
        function renderNotifications() {
            const container = document.getElementById('notificationList');
            
            const filtered = currentFilter === 'all' 
                ? allNotifications 
                : allNotifications.filter(n => n.type === currentFilter);

            if (filtered.length === 0) {
                showEmptyNotifications();
                return;
            }

            container.innerHTML = filtered.map(notif => `
                <div class="notification-item ${notif.type}">
                    <div class="notification-header">
                        <span class="notification-type ${notif.type}">
                            ${notif.type === 'timeout' ? 'âš ï¸ íƒ€ì„ì•„ì›ƒ' : 'âœ… ë³µêµ¬'}
                        </span>
                        <span class="notification-time">${notif.date} ${notif.time}</span>
                    </div>
                    <div class="notification-name">${notif.name}</div>
                    <div class="notification-ip">${notif.ip}</div>
                </div>
            `).join('');
        }

        // Show Empty Notifications
        function showEmptyNotifications() {
            const container = document.getElementById('notificationList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <div>ì•„ì§ ì•Œë¦¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            `;
        }

        // Update Loop
        function startUpdates() {
            updateInterval = setInterval(() => {
                loadData();
            }, 1000);
        }

        function stopUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        }
    </script>
</body>
</html>
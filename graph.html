<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Monitor Dashboard</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>ğŸŒ Ping Monitor Dashboard</h1>
        <div class="header-subtitle">Real-time Network Monitoring</div>
    </div>

    <!-- Tab Navigation -->
    <div class="container">
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab-btn" data-tab="notifications">ğŸ”” ì•Œë¦¼ ê¸°ë¡</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <!-- Control Panel -->
            <div class="card">
                <div class="control-panel">
                    <button class="btn btn-primary" id="toggleBtn">ì¼ì‹œì •ì§€</button>
                    <button class="btn btn-success" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <!-- Global Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ì „ì²´ IP</div>
                    <div class="stat-value" id="totalIPs">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì˜¨ë¼ì¸</div>
                    <div class="stat-value" style="color: var(--success);" id="onlineCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì˜¤í”„ë¼ì¸</div>
                    <div class="stat-value" style="color: var(--error);" id="offlineCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">í‰ê·  ì§€ì—°</div>
                    <div class="stat-value" id="avgLatency">0</div>
                </div>
            </div>

            <!-- Comparison Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">IP ë¹„êµ íƒ€ì„ë¼ì¸</div>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- IP Cards -->
            <div id="ipCardsContainer" class="ip-grid"></div>
        </div>

        <!-- Notifications Tab -->
        <div class="tab-content" id="notifications">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ì „ì²´ ì•Œë¦¼</div>
                    <div class="stat-value" id="notifTotalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">íƒ€ì„ì•„ì›ƒ</div>
                    <div class="stat-value" style="color: var(--error);" id="notifTimeoutCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ë³µêµ¬</div>
                    <div class="stat-value" style="color: var(--success);" id="notifRecoveryCount">0</div>
                </div>
            </div>

            <!-- Notification Log -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì•Œë¦¼ ê¸°ë¡</div>
                </div>
                
                <div class="filter-bar">
                    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
                    <button class="filter-btn" data-filter="timeout">íƒ€ì„ì•„ì›ƒë§Œ</button>
                    <button class="filter-btn" data-filter="recovery">ë³µêµ¬ë§Œ</button>
                </div>

                <div class="notification-list" id="notificationList">
                    <div class="loading">ì•Œë¦¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let isRunning = true;
        let updateInterval;
        let comparisonChart;
        let ipCharts = {};
        let currentData = null;
        
        // Notification State
        let allNotifications = [];
        let currentFilter = 'all';

        // Tab Switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');
                
                // Load notifications when switching to that tab
                if (tabName === 'notifications') {
                    loadNotifications();
                }
            });
        });

        // Initialize Charts
        function initComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#e4e6eb' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3f5c' },
                            ticks: { color: '#b0b3b8' }
                        },
                        x: {
                            grid: { color: '#3a3f5c' },
                            ticks: { color: '#b0b3b8' }
                        }
                    }
                }
            });
        }

        function createIPChart(canvasId) {
            const ctx = document.getElementById(canvasId);
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [{
                        label: 'Latency (ms)',
                        data: [],
                        borderColor: '#4c6ef5',
                        backgroundColor: 'rgba(76, 110, 245, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3f5c' },
                            ticks: { color: '#b0b3b8' }
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
        }

        // Load Data
        async function loadData() {
            try {
                const response = await fetch('/ping_data.json?t=' + Date.now());
                const data = await response.json();
                currentData = data;
                updateUI(data);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // Update UI
        function updateUI(data) {
            if (!data || !data.targets) return;

            // Update global stats
            const onlineCount = data.targets.filter(t => t.online).length;
            const offlineCount = data.targets.length - onlineCount;
            const avgLatency = Math.round(
                data.targets.reduce((sum, t) => sum + (t.online ? t.latency : 0), 0) / 
                (onlineCount || 1)
            );

            document.getElementById('totalIPs').textContent = data.targets.length;
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('offlineCount').textContent = offlineCount;
            document.getElementById('avgLatency').textContent = avgLatency + ' ms';

            // Update comparison chart
            updateComparisonChart(data.targets);

            // Update IP cards
            updateIPCards(data.targets);
        }

        // Update Comparison Chart
        function updateComparisonChart(targets) {
            const labels = Array(60).fill('').map((_, i) => (60 - i) + 's');
            
            comparisonChart.data.labels = labels;
            comparisonChart.data.datasets = targets.map(target => ({
                label: target.name,
                data: target.history,
                borderColor: getRandomColor(target.ip),
                tension: 0.4,
                borderWidth: 2
            }));
            
            comparisonChart.update();
        }

        // Update IP Cards
        function updateIPCards(targets) {
            const container = document.getElementById('ipCardsContainer');
            
            targets.forEach((target, index) => {
                let card = document.getElementById(`ip-card-${index}`);
                
                if (!card) {
                    card = createIPCard(target, index);
                    container.appendChild(card);
                    ipCharts[index] = createIPChart(`chart-${index}`);
                }
                
                updateIPCard(card, target, index);
            });
        }

        // Create IP Card
        function createIPCard(target, index) {
            const card = document.createElement('div');
            card.id = `ip-card-${index}`;
            card.className = 'ip-card';
            card.innerHTML = `
                <div class="ip-header">
                    <div>
                        <div class="ip-name">${target.name}</div>
                        <div class="ip-address">${target.ip}</div>
                    </div>
                    <span class="status-badge" id="status-${index}">ì˜¤í”„ë¼ì¸</span>
                </div>
                <div class="chart-container">
                    <canvas id="chart-${index}"></canvas>
                </div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-item-label">ì§€ì—°ì‹œê°„</div>
                        <div class="stat-item-value" id="latency-${index}">0 ms</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">ìµœì†Œ</div>
                        <div class="stat-item-value" id="min-${index}">0 ms</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">í‰ê· </div>
                        <div class="stat-item-value" id="avg-${index}">0 ms</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">ìµœëŒ€</div>
                        <div class="stat-item-value" id="max-${index}">0 ms</div>
                    </div>
                </div>
                <div class="packet-bars" id="packets-${index}"></div>
            `;
            return card;
        }

        // Update IP Card
        function updateIPCard(card, target, index) {
            // Status
            const statusBadge = document.getElementById(`status-${index}`);
            statusBadge.textContent = target.online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
            statusBadge.className = target.online ? 'status-badge status-online' : 'status-badge status-offline';

            // Stats
            document.getElementById(`latency-${index}`).textContent = target.latency + ' ms';
            document.getElementById(`min-${index}`).textContent = target.min + ' ms';
            document.getElementById(`avg-${index}`).textContent = Math.round(target.avg) + ' ms';
            document.getElementById(`max-${index}`).textContent = target.max + ' ms';

            // Chart
            if (ipCharts[index]) {
                ipCharts[index].data.datasets[0].data = target.history;
                ipCharts[index].update();
            }

            // Packet bars
            const packetsContainer = document.getElementById(`packets-${index}`);
            packetsContainer.innerHTML = target.history.map(latency => {
                const className = latency > 0 ? 'packet-bar packet-success' : 'packet-bar packet-fail';
                return `<div class="${className}"></div>`;
            }).join('');
        }

        // Load Notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/notification_log.json?t=' + Date.now());
                if (!response.ok) {
                    showEmptyNotifications();
                    return;
                }
                
                const logs = await response.json();
                allNotifications = logs.reverse();
                
                updateNotificationStats();
                renderNotifications();
            } catch (error) {
                console.error('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                showEmptyNotifications();
            }
        }

        // Update Notification Stats
        function updateNotificationStats() {
            const total = allNotifications.length;
            const timeouts = allNotifications.filter(n => n.type === 'timeout').length;
            const recoveries = allNotifications.filter(n => n.type === 'recovery').length;

            document.getElementById('notifTotalCount').textContent = total;
            document.getElementById('notifTimeoutCount').textContent = timeouts;
            document.getElementById('notifRecoveryCount').textContent = recoveries;
        }

        // Render Notifications
        function renderNotifications() {
            const container = document.getElementById('notificationList');
            
            const filtered = currentFilter === 'all' 
                ? allNotifications 
                : allNotifications.filter(n => n.type === currentFilter);

            if (filtered.length === 0) {
                showEmptyNotifications();
                return;
            }

            container.innerHTML = filtered.map(notif => `
                <div class="notification-item ${notif.type}">
                    <div class="notification-header">
                        <span class="notification-type ${notif.type}">
                            ${notif.type === 'timeout' ? 'âš ï¸ íƒ€ì„ì•„ì›ƒ' : 'âœ… ë³µêµ¬'}
                        </span>
                        <span class="notification-time">${notif.date} ${notif.time}</span>
                    </div>
                    <div class="notification-name">${notif.name}</div>
                    <div class="notification-ip">${notif.ip}</div>
                </div>
            `).join('');
        }

        // Show Empty Notifications
        function showEmptyNotifications() {
            const container = document.getElementById('notificationList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <div>ì•„ì§ ì•Œë¦¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            `;
        }

        // Notification Filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderNotifications();
            });
        });

        // Control Buttons
        document.getElementById('toggleBtn').addEventListener('click', () => {
            isRunning = !isRunning;
            const btn = document.getElementById('toggleBtn');
            btn.textContent = isRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘';
            btn.className = isRunning ? 'btn btn-primary' : 'btn btn-success';
            
            if (isRunning) {
                startUpdates();
            } else {
                stopUpdates();
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadData();
            loadNotifications();
        });

        // Update Loop
        function startUpdates() {
            updateInterval = setInterval(() => {
                loadData();
            }, 1000);
        }

        function stopUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        }

        // Utility: Random Color
        function getRandomColor(seed) {
            const colors = [
                '#4c6ef5', '#51cf66', '#ffd43b', '#ff6b6b',
                '#9775fa', '#20c997', '#ff922b', '#748ffc'
            ];
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // Initialize
        initComparisonChart();
        loadData();
        startUpdates();
    </script>
</body>
</html>